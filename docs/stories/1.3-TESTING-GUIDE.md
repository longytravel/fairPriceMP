# Story 1.3 Testing Guide

## Testing Overview
This guide covers testing for Story 1.3: Pair-Isolated Risk & State Management

## Pre-requisites
- All files compiled successfully in MT5
- MT5 Strategy Tester available
- Demo account recommended for safety

---

## Test Suite 1: Unit Tests

### Location
`Scripts/Test_SymbolEngine_Risk.mq5`

### Execution Steps
1. Open MT5 MetaEditor
2. Navigate to Scripts folder
3. Open `Test_SymbolEngine_Risk.mq5`
4. Compile (F7)
5. In MT5 Terminal → Navigator → Scripts
6. Drag `Test_SymbolEngine_Risk` onto any chart
7. Check Experts tab in terminal

### Expected Results
```
=== Test_SymbolEngine_Risk: Starting Test Suite ===
[PASS] Test_EquityTracking
[PASS] Test_DrawdownCalculation
[PASS] Test_SymbolRuntimeStateInit
[PASS] Test_SymbolIsolation
[PASS] Test_ConfigEntryValidation
=== Test Results: 5/5 passed ===
```

### Acceptance Criteria Coverage
- ✅ AC1: Equity tracking calculations
- ✅ AC1: Drawdown formula validation
- ✅ AC2: Symbol state isolation
- ✅ AC2: Configuration validation

---

## Test Suite 2: Single-Symbol Equity Stop Demo

### Location
`Experts/fairPriceMP/Test_EquityStop_Demo.mq5`

### Purpose
Verify equity tracking and equity stop logic on a single symbol

### Execution Steps
1. Compile `Test_EquityStop_Demo.mq5`
2. Attach to EURUSD chart (or any liquid pair)
3. Set input parameter `TestDrawdownThreshold = 10.0` (10%)
4. Allow EA to run and open positions
5. Monitor chart comment for real-time metrics

### What to Verify

#### ✅ Equity Tracking (AC1)
- [ ] Peak equity increases when positions are profitable
- [ ] Current equity updates every tick
- [ ] Drawdown % calculated correctly: `(Peak - Current) / Peak * 100`
- [ ] Logs show `EQY_UPD` events with symbol name

#### ✅ Equity Stop Logic (AC1)
- [ ] When drawdown reaches threshold, equity stop triggers
- [ ] All positions for the symbol close immediately
- [ ] Pending orders for the symbol are deleted
- [ ] Log shows `EQY_STOP` event with final drawdown and trade count
- [ ] MT5 Alert popup displays with symbol and drawdown info
- [ ] Symbol gets blocked (IsBlocked = true)
- [ ] BlockReason shows "Equity stop: X.XX% drawdown"
- [ ] No new positions open after equity stop

#### ✅ Logging (AC3)
- [ ] All log entries include `[SYMBOL]` identifier
- [ ] Event codes are ASCII, max 10 chars, UPPER_SNAKE_CASE
- [ ] Check log file: `MQL5/Files/fairPriceMP/test_equity_stop_YYYY.MM.DD.log`

### Test Scenarios

#### Scenario A: Profitable Run (No Stop)
1. Let EA open positions
2. If market moves favorably:
   - Peak equity should increase
   - Drawdown should remain low
   - No equity stop should trigger
   - Symbol remains tradeable

#### Scenario B: Drawdown Triggers Stop
1. Lower `TestDrawdownThreshold` to 5% for faster testing
2. Wait for market movement against positions
3. When drawdown hits 5%:
   - Equity stop should trigger immediately
   - All positions close
   - Alert popup appears
   - Symbol blocked
   - Check logs for `EQY_STOP` event

---

## Test Suite 3: Multi-Symbol Isolation Test

### Location
`Experts/fairPriceMP/Test_MultiSymbol_Isolation.mq5`

### Purpose
Verify that equity tracking, stops, and state are isolated per symbol

### Execution Steps
1. Compile `Test_MultiSymbol_Isolation.mq5`
2. Attach to any chart
3. Default settings:
   - Symbol1 = EURUSD (Drawdown threshold: 10%)
   - Symbol2 = GBPUSD (Drawdown threshold: 15%)
4. Enable both symbols in Market Watch
5. Run EA and monitor dashboard

### What to Verify

#### ✅ State Isolation (AC2)
- [ ] Each symbol maintains independent peak equity
- [ ] Each symbol maintains independent current equity
- [ ] Each symbol calculates drawdown independently
- [ ] Position counts are symbol-specific (no leakage)
- [ ] Pending order counts are symbol-specific

#### ✅ Equity Stop Isolation (AC1)
- [ ] Trigger equity stop on Symbol1 only (lower its threshold to 5%)
- [ ] Verify Symbol1 positions close
- [ ] Verify Symbol2 positions REMAIN OPEN
- [ ] Verify Symbol1 is blocked
- [ ] Verify Symbol2 continues trading normally
- [ ] Verify dashboard shows Symbol1 blocked, Symbol2 active

#### ✅ Dashboard Display (AC3)
- [ ] Dashboard shows both symbols in separate rows
- [ ] Each row displays:
  - Symbol name
  - Signal state (BUY/SELL/IDLE/BLOCKED)
  - Open trades count
  - Grid levels count
  - Drawdown %
  - Correlation block status (if applicable)
  - Last action timestamp
- [ ] Summary strip shows:
  - Total symbols (2)
  - Max drawdown across symbols
  - Count of blocked symbols

#### ✅ Indicator Handles Isolation (AC2)
- [ ] Each engine maintains independent EMA handles
- [ ] Symbol1 EMA values don't affect Symbol2
- [ ] Verify in logs that each symbol processes ticks independently

---

## Test Suite 4: Strategy Tester Regression (E2E)

### Purpose
Compare single-symbol vs multi-symbol EA behavior for parity (AC4)

### Setup Required
1. Configure fairPriceMP EA for single-symbol mode
2. Configure fairPriceMP EA for multi-symbol mode
3. Use same symbol (e.g., EURUSD) in both tests
4. Use identical parameters (lot size, EMA periods, trigger pips, etc.)

### Execution Steps

#### Run 1: Single-Symbol Mode
1. Open MT5 Strategy Tester
2. Select fairPriceMP EA (single-symbol configuration)
3. Symbol: EURUSD
4. Period: M5
5. Date range: 1 month
6. Settings: Enable equity stop at 10% drawdown
7. Run test
8. Export results:
   - Backtest report
   - Log file (`MQL5/Files/fairPriceMP/logs/`)
9. Note final equity, drawdown events, trade count

#### Run 2: Multi-Symbol Mode (Same Symbol)
1. Configure EA with only EURUSD enabled
2. Same parameters as Run 1
3. Same date range
4. Run test
5. Export results

### Comparison Checklist (AC4)

#### ✅ Equity Parity
- [ ] Final equity values within 0.01% tolerance
- [ ] Peak equity values match within 0.01%
- [ ] Drawdown calculations match within 0.01%

#### ✅ Event Timing Parity
- [ ] `EQY_UPD` events occur at same timestamps (within 1 tick)
- [ ] `EQY_STOP` triggers at same time (within 1 tick)
- [ ] Trade entry/exit times match

#### ✅ Trade Count Parity
- [ ] Same number of total trades executed
- [ ] Same number of positions closed by equity stop
- [ ] Same grid levels placed

#### ✅ Log Diff Analysis
1. Export both log files
2. Use PowerShell script to compare:
```powershell
# Compare equity events
$log1 = Get-Content "single_symbol.log" | Select-String "EQY_"
$log2 = Get-Content "multi_symbol.log" | Select-String "EQY_"
Compare-Object $log1 $log2
```
3. Document discrepancies
4. Confirm discrepancies are within acceptable tolerance

---

## Test Suite 5: Stress Test - Multiple Symbols Under Load

### Purpose
Verify system stability with multiple symbols hitting equity stops

### Setup
1. Configure 5 symbols: EURUSD, GBPUSD, USDJPY, EURJPY, GBPJPY
2. Set aggressive drawdown thresholds (3-5%)
3. Enable all in multi-symbol EA

### What to Verify
- [ ] System handles concurrent equity stops
- [ ] No cross-contamination when multiple symbols stop simultaneously
- [ ] Logs remain coherent and show correct symbol identifiers
- [ ] Dashboard updates correctly for all symbols
- [ ] Position counts remain accurate across all symbols
- [ ] MT5 doesn't crash or hang

---

## Success Criteria Summary

### Must Pass (All Tests)
- ✅ All 5 unit tests pass
- ✅ Single-symbol equity stop demo functions correctly
- ✅ Multi-symbol isolation verified (no state leakage)
- ✅ Dashboard displays correct telemetry for all symbols
- ✅ Logs include symbol identifiers in all entries
- ✅ Equity stop closes only affected symbol's positions

### Should Pass (E2E)
- ✅ Strategy tester parity within tolerance thresholds
- ✅ Equity values within 0.01%
- ✅ Event timestamps within 1 tick

### Stress Test (Optional but Recommended)
- ✅ Multiple symbols can trigger equity stops without system failure
- ✅ Performance remains acceptable (tick processing < 10ms)

---

## Troubleshooting

### Issue: Unit tests fail
- Check that DTOs compiled correctly
- Verify SymbolRuntimeState has all new fields (PeakEquity, CurrentEquity, DrawdownPercent, OpenTrades)
- Recompile all includes

### Issue: Equity stop doesn't trigger
- Verify MaxDrawdownPercent > 0 in config
- Check that positions are opening (need equity movement)
- Lower threshold to 3% for faster testing
- Check logs for `EQY_UPD` events to confirm tracking is working

### Issue: Dashboard not displaying
- Verify chart has space for objects (top-left corner)
- Check Experts tab for object creation errors
- Ensure `DashboardRenderer.mqh` compiled successfully

### Issue: Wrong symbol positions close
- Check `TradeProxy.CloseAll()` implementation
- Verify symbol filtering in position loops
- Enable detailed logging to trace which symbol triggers stop

---

## Next Steps After Testing

1. Document all test results
2. Update story QA Results section
3. Create bug tickets for any failures
4. Run E2E strategy tester regression
5. Mark story as "Tested - Ready for Deployment"
